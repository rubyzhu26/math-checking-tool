import { GoogleGenerativeAI, SchemaType } from "@google/generative-ai";
import { AuditResult, FilePart } from "../types";

const AUDIT_PROMPT = `
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 20 å¹´ç»éªŒçš„èµ„æ·±æ–‡å­—æ ¡å¯¹ä¸“å®¶å’Œæ•°å­¦æ•™æå®¡æ ¡ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹è¾“å…¥çš„æ•°å­¦ç»ƒä¹ å†Œæ–‡æ¡£ï¼ˆå›¾ç‰‡æˆ– PDFï¼‰è¿›è¡Œä¸¥è‹›çš„è´¨é‡å®¡æ ¸ã€‚

### æ ¸å¿ƒä»»åŠ¡æµç¨‹
1. **é€å­— OCR æå–**ï¼šè¯·å…ˆå°†å›¾ç‰‡æˆ–æ–‡æ¡£ä¸­çš„æ‰€æœ‰æ–‡å­—åŸå°ä¸åŠ¨åœ°æå–å‡ºæ¥ã€‚ä¸¥ç¦è‡ªåŠ¨ä¿®æ­£ä»»ä½•ä½ è®¤ä¸ºâ€œå†™é”™â€çš„å­—ã€‚å¿…é¡»ä¿ç•™åŸå§‹çŠ¶æ€ã€‚
2. **æ·±åº¦çº é”™**ï¼šåŸºäºæå–çš„æ–‡å­—ä¸ç”»é¢å†…å®¹ï¼Œå¯¹æ¯”ä»¥ä¸‹æ ‡å‡†è¿›è¡Œæ ¡å¯¹ï¼š

#### ä¸€ã€æ•™å­¦é”™è¯¯ (Pedagogical)
- **ä¹˜é™¤æ³•åˆ—å¼**ï¼šä¸¥æ ¼æ£€æŸ¥â€œå‡ ä¸ªå‡ â€çš„é€»è¾‘ã€‚æ–°æ•™æè¦æ±‚ï¼šç›¸åŒæ•°åœ¨å‰ï¼Œä¸ªæ•°åœ¨åã€‚ä¾‹å¦‚ï¼š3ä¸ª9å¿…é¡»åˆ—å¼ä¸º 9Ã—3ï¼Œä¸¥ç¦å†™æˆ 3Ã—9ã€‚
- **å›¾æ–‡ä¸€è‡´æ€§**ï¼šæ£€æŸ¥é¢˜ç›®é…å›¾æ˜¯å¦ä¸é¢˜ç›®å†…å®¹ç›¸å…³ã€‚ä¾‹å¦‚ï¼šåŠ å‡æ³•å•å…ƒä¸­ä¸èƒ½å‡ºç°ä¹˜é™¤æ³•é…å›¾ã€‚

#### äºŒã€ç”»é¢è®¾è®¡é”™è¯¯ (Visual/Design)
- **å“ç‰Œè§„èŒƒ**ï¼šæ£€æŸ¥â€œæ–‘é©¬Logoâ€ç»†èŠ‚ã€‚å¯¹æ¯”æ ‡å‡†ç‰ˆï¼Œæ£€æŸ¥æ˜¯å¦ç¼ºå¤±è€³æœµã€çœ¼ç›ç­‰å…³é”®ç»†èŠ‚ã€‚
- **å›¾å±‚é€»è¾‘**ï¼šæ’ç”»å¿…é¡»åœ¨ç¬¬ä¸€å±‚ï¼Œä¸¥ç¦è¢«èƒŒæ™¯æˆ–å…¶ä»–åº•å›¾ç›–ä½ã€‚
- **ä¸€è‡´æ€§**ï¼š
  - å°é¢ã€ç›®å½•é…å›¾å¿…é¡»ä¸å•å…ƒæ•™å­¦å†…å®¹åŒ¹é…ã€‚
  - ç»ƒä¹ å†Œé¢˜ç›®å›¾ç‰‡å¿…é¡»ä¸ç­”æ¡ˆä¸­çš„å¯¹åº”é¢˜ç›®å›¾ç‰‡å®Œå…¨ä¸€è‡´ã€‚
  - é™„é¡µå›¾ç‰‡å¿…é¡»ä¸å†…é¡µå›¾ç”»ä¸€è‡´ã€‚
  - é¢˜ç›®å‰å›¾æ ‡ä¸¥ç¦ç¼ºå¤±æˆ–è¯¯ç”¨ã€‚

#### ä¸‰ã€æ–‡å­—çº é”™ (Textual) - **é‡ä¸­ä¹‹é‡**
- **é”™åˆ«å­—**ï¼šé‡ç‚¹æŸ¥æ€å½¢è¿‘å­—ã€åŒéŸ³å­—ã€ç¬”ç”»/åæ—é”™è¯¯ã€‚
- **è¯­å¥é€šé¡º**ï¼šä¸¥æŸ¥å°‘å­—ã€æ¼å­—ã€é¢ å€’å­—ã€‚
- **å•ä½è§„èŒƒ**ï¼šè®¡é‡å•ä½å¿…é¡»ä½¿ç”¨æ­£ç¡®ä¸”å…¨é¢˜ä¸€è‡´ã€‚
- **å¼•å¯¼è¯­ä¸€è‡´æ€§**ï¼šåŒç±»å‹é¢˜ç›®å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„å¼•å¯¼è¯­ã€‚
- **è¯­è¨€ç¦ä»¤**ï¼šä¸¥ç¦å‡ºç°éå¿…è¦çš„è‹±æ–‡ã€‚
- **ç¼–æ’é€»è¾‘**ï¼šé¡µç ã€é¢˜å·é¡ºåºå¿…é¡»æ­£ç¡®ã€‚
- **é—´è·ä¸å­—å·**ï¼šå›¾æ ‡ä¸é¢˜ç›®é—´è·ä¸èƒ½è¿‡è¿œï¼›åŒä¸€å…ƒç´ å­—å·å¿…é¡»ä¸€è‡´ã€‚

#### å››ã€æ ‡ç‚¹ç¬¦å·è§„èŒƒ (Punctuation)
- **æ ‡ç‚¹è¯¯ç”¨**ï¼šå¥å°¾æ¼æ ‡ç‚¹æˆ–æ ‡ç‚¹é”™è¯¯ã€‚
- **å…¨åŠè§’ä¸€è‡´æ€§**ï¼šåŒä¸€é¢˜ä¸­ï¼Œé¢˜å¹²ä¸é¢˜ç›®å†…çš„æ‹¬å·å¿…é¡»ç»Ÿä¸€ã€‚
- **æ‹¬å·ä½ç½®**ï¼šå¸¦æ‹¬å·å¤‡æ³¨çš„å¥å­ï¼Œå¥å·å¿…é¡»æ”¾åœ¨å°æ‹¬å·åé¢ã€‚
- **ç¬¦å·å­—ä½“**ï¼šå…¨ä¹¦è¿ç®—ç¬¦å·æ ¼å¼å¿…é¡»é«˜åº¦ç»Ÿä¸€ã€‚
- **å¼•ç”¨è§„èŒƒ**ï¼šå¼•ç”¨å†…å®¹å¿…é¡»åŠ åŒå¼•å·ã€‚

### è¾“å‡ºæ ¼å¼è¦æ±‚
è¯·è¾“å‡º JSON æ•°ç»„ã€‚å¦‚æœè¾“å…¥æ˜¯å¤šé¡µ PDFï¼Œè¯·ä¸ºæ¯ä¸€é¡µç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ç»“æœå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡å¿…é¡»åŒ…å«ï¼š
- \`pageNumber\`: é¡µç ã€‚
- \`ocrText\`: é€å­—æå–çš„åŸå§‹æ–‡æœ¬ã€‚
- \`errors\`: çº é”™æ¸…å•ã€‚æè¿°éœ€ä¸¥æ ¼éµå¾ªï¼šâŒ é”™è¯¯ï¼š[åŸè¯] -> âœ… å»ºè®®ï¼š[æ­£ç¡®è¯] (åŸå› ï¼š[ç®€è¿°åŸå› ])ã€‚
`;

const RESPONSE_SCHEMA = {
  type: SchemaType.ARRAY,
  items: {
    type: SchemaType.OBJECT,
    properties: {
      pageNumber: { type: SchemaType.INTEGER },
      ocrText: { type: SchemaType.STRING },
      errors: {
        type: SchemaType.ARRAY,
        items: {
          type: SchemaType.OBJECT,
          properties: {
            category: { type: SchemaType.STRING },
            description: { type: SchemaType.STRING },
            suggestion: { type: SchemaType.STRING },
            severity: { type: SchemaType.STRING }
          },
          required: ["category", "description", "suggestion", "severity"]
        }
      }
    },
    required: ["pageNumber", "ocrText", "errors"]
  }
};

export const analyzeWorkbookPages = async (files: FilePart[]): Promise<AuditResult[]> => {
  const apiKey = import.meta.env.VITE_API_KEY || ""; 
  const genAI = new GoogleGenerativeAI(apiKey);

  const parts = files.map(file => ({
    inlineData: {
      mimeType: file.mimeType,
      data: file.data.split(',')[1] || file.data
    }
  }));

  try {
    // ğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šå»æ‰æ‰€æœ‰å‰ç¼€ï¼Œåªç•™ç®€å†™åï¼Œå¹¶å¼ºåˆ¶æŒ‡å®š v1beta ç‰ˆæœ¬
    const model = genAI.getGenerativeModel(
      { model: "gemini-1.5-flash" }, 
      { apiVersion: "v1beta" }
    );
    
    const result = await model.generateContent({
      contents: [{ role: "user", parts: [...parts, { text: AUDIT_PROMPT }] }],
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: RESPONSE_SCHEMA
      }
    });

    const response = await result.response;
    const text = response.text();
    
    // ğŸŒŸ è°ƒè¯•ç¬¬äºŒæ­¥ï¼šåœ¨æ§åˆ¶å°æ‰“å°åŸå§‹ç»“æœï¼Œæ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥è¯†åˆ«å¥½ä¸å¥½
    console.log("AI åŸå§‹è§£æå†…å®¹:", text);

    if (!text) return [];
    return JSON.parse(text);

  } catch (err) {
    console.error("AI æœ€ç»ˆè°ƒç”¨å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…:", err);
    // ğŸŒŸ ä¿å‘½ä»£ç ï¼šæŠ¥é”™æ—¶è¿”å›ç©ºï¼Œé˜²æ­¢å‰ç«¯å¼¹å‡ºçº¢æ¡†å´©æºƒ
    return []; 
  }
};
